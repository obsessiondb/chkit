<system_instruction>
You are working inside Conductor, a Mac app that lets the user run many coding agents in parallel.
Your work should take place in the /Users/marc/conductor/workspaces/chkit/davao directory (unless otherwise directed), which has been set up for you to work in.
Each workspace has a .context directory (gitignored) where you can save files to collaborate with other agents.
The target branch for this workspace is rename-chkit. Use this for actions like creating new PRs, bisecting, etc., unless you're told otherwise.

If the user asks you to work on several unrelated tasks in parallel, you can suggest they start new workspaces.
If the user asks for help with Conductor, ask them to email [humans@conductor.build](mailto:humans@conductor.build) or
click on the comment icon in the bottom left to send feedback.
</system_instruction>

@.context/plan-command-pages.md

---

<task-notification>
<task-id>aefa883</task-id>
<status>completed</status>
<summary>Agent "Read existing plugin docs pages" completed</summary>
<result>Here is a summary of every documentation file found, along with its full content and the sidebar configuration.

---

## Summary of Existing Documentation

### Sidebar Configuration

**File:** `/Users/marc/conductor/workspaces/chkit/davao/apps/docs/astro.config.mjs`

The Starlight sidebar is organized into five sections:

1. **Overview** -- manually listed items: Introduction (`index`), Getting Started (`getting-started`), Documentation Structure (`documentation-structure`).
2. **CLI Reference** -- autogenerated from the `cli/` directory.
3. **Configuration** -- autogenerated from the `configuration/` directory.
4. **Schema** -- autogenerated from the `schema/` directory.
5. **Plugins** -- autogenerated from the `plugins/` directory.

Full content:

```js
// @ts-check
import { defineConfig } from 'astro/config';
import starlight from '@astrojs/starlight';

export default defineConfig({
  integrations: [
    starlight({
      title: 'chkit Docs',
      description: 'Public documentation for chkit, the ClickHouse schema and migration CLI.',
      customCss: ['./src/styles/custom.css'],
      sidebar: [
        {
          label: 'Overview',
          items: [
            { label: 'Introduction', slug: 'index' },
            { label: 'Getting Started', slug: 'getting-started' },
            { label: 'Documentation Structure', slug: 'documentation-structure' },
          ],
        },
        {
          label: 'CLI Reference',
          autogenerate: { directory: 'cli' },
        },
        {
          label: 'Configuration',
          autogenerate: { directory: 'configuration' },
        },
        {
          label: 'Schema',
          autogenerate: { directory: 'schema' },
        },
        {
          label: 'Plugins',
          autogenerate: { directory: 'plugins' },
        },
      ],
    }),
  ],
});
```

---

### CLI Directory

**Only one file exists:** `/Users/marc/conductor/workspaces/chkit/davao/apps/docs/src/content/docs/cli/overview.md`

This is a compact reference listing all CLI commands and their flags. It covers `init`, `generate`, `codegen`, `migrate`, `status`, `drift`, `check`, `plugin`, and `version`. It also documents two global flags: `--config` and `--json`.

Full content:

```md
---
title: CLI Overview
description: Command surface of the chkit CLI.
---

## Commands

- `chkit init`
- `chkit generate [--name <migration-name>] [--migration-id <id>] [--config <path>] [--dryrun] [--json]`
- `chkit codegen [--check] [--out-file <path>] [--emit-zod] [--no-emit-zod] [--emit-ingest] [--no-emit-ingest] [--ingest-out-file <path>] [--bigint-mode <string|bigint>] [--include-views] [--config <path>] [--json]`
- `chkit migrate [--config <path>] [--apply|--execute] [--allow-destructive] [--json]`
- `chkit status [--config <path>] [--json]`
- `chkit drift [--config <path>] [--json]`
- `chkit check [--config <path>] [--strict] [--json]`
- `chkit plugin [<plugin-name> [<command> ...]] [--config <path>] [--json]`
- `chkit version`

## Global Flags

- `--config <path>`: config file path (default `clickhouse.config.ts`)
- `--json`: machine-readable output
```

---

### Plugins Directory

Three files exist in `/Users/marc/conductor/workspaces/chkit/davao/apps/docs/src/content/docs/plugins/`:

#### 1. Pull Plugin

**File:** `/Users/marc/conductor/workspaces/chkit/davao/apps/docs/src/content/docs/plugins/pull.md`

This documents the `@chkit/plugin-pull` package. It introspects live ClickHouse tables, views, and materialized views and generates a deterministic TypeScript schema file using `@chkit/core` builders. Sections cover: what it does, workflow integration, plugin setup (config example with `outFile`, `databases`, `overwrite`), all options, the `chkit pull` / `chkit plugin pull schema` command with flags (`--out-file`, `--database`, `--dryrun`, `--force`/`--overwrite`), the generated output format (with a full TypeScript example), and current limits.

Key cross-reference points:
- References `chkit generate` and `chkit check` as downstream consumers of the generated schema file.
- Uses `defineConfig` from `@chkit/core`.

#### 2. Backfill Plugin

**File:** `/Users/marc/conductor/workspaces/chkit/davao/apps/docs/src/content/docs/plugins/backfill.md`

This documents the `@chkit/plugin-backfill` package. It covers time-windowed backfill operations with a plan-then-execute lifecycle. Sections include: what it does, workflow overview (plan/run/status), plugin setup (config example with `stateDir`, `defaults`, `policy`, `limits` groups), all options in three tables, six subcommands (`plan`, `run`, `resume`, `status`, `cancel`, `doctor`) each with flag tables, CI/check integration with finding codes (`backfill_required_pending`, `backfill_chunk_failed_retry_exhausted`, `backfill_policy_relaxed`), state management (file layout and deterministic plan IDs), common workflows (basic backfill, failed chunk recovery, CI enforcement), and current limits.

Key cross-reference points:
- Integrates with `chkit check` (can add `plugin:backfill` to failed checks).
- Uses `defineConfig` from `@chkit/core`.

#### 3. Codegen Plugin

**File:** `/Users/marc/conductor/workspaces/chkit/davao/apps/docs/src/content/docs/plugins/codegen.md`

This documents the `@chkit/plugin-codegen` package. It generates TypeScript row types, optional Zod schemas, and ingestion functions from chkit schema definitions. Sections cover: what it does, workflow integration (with `chkit generate`, `chkit check`, and `chkit codegen`), plugin setup (config example with all options), all options listed (`outFile`, `emitZod`, `emitIngest`, `ingestOutFile`, `tableNameStyle`, `bigintMode`, `includeViews`, `runOnGenerate`, `failOnUnsupportedType`), the `chkit codegen` command and `--check` mode with finding codes, CI/check integration, generate integration, and current limits.

Key cross-reference points:
- Integrates with `chkit generate` (runs automatically when `runOnGenerate` is true).
- Integrates with `chkit check` (can add `plugin:codegen` to failed checks).
- Finding codes: `codegen_missing_output`, `codegen_stale_output`, `codegen_missing_ingest_output`, `codegen_stale_ingest_output`.
- Uses `defineConfig` from `@chkit/core`.

---

### Cross-Reference Opportunities

The following topics are mentioned across multiple docs but could benefit from explicit cross-linking:

- **`chkit check`** is referenced by all three plugins (codegen, backfill, pull) and the CLI overview. Each plugin documents its own check integration findings. The CLI overview lists the command but does not detail per-plugin check behavior.
- **`chkit generate`** is referenced by the codegen plugin (runs on generate) and the pull plugin (generated schema works with generate). The CLI overview lists the command.
- **`defineConfig` and `clickhouse.config.ts`** appear in all three plugin setup examples. The configuration section (autogenerated from the `configuration/` directory) would be the natural place to link to.
- **Schema files** are referenced by both the pull plugin (generates them) and the codegen plugin (consumes them to produce types). The schema section (autogenerated from the `schema/` directory) is the related sidebar section.
- **Plugin registration** pattern (`plugins: [...]` array in `defineConfig`) is repeated identically across all three plugin docs. The configuration overview would be a natural single source of truth to link to.
- **The CLI overview** (`cli/overview.md`) is the only file in the CLI Reference sidebar section. The `chkit codegen` command is documented both there and in the codegen plugin doc. The `chkit plugin` command in the CLI overview is the gateway to plugin-specific subcommands documented in the three plugin pages.</result>
<usage>total_tokens: 14208
tool_uses: 7
duration_ms: 45835</usage>
</task-notification>
Full transcript available at: /private/tmp/claude-501/-Users-marc-conductor-workspaces-chkit-davao/tasks/aefa883.output

---

<task-notification>
<task-id>a59284b</task-id>
<status>completed</status>
<summary>Agent "Read all CLI command source files" completed</summary>
<result>I now have a thorough understanding of every source file. Here is the comprehensive summary.

---

## Comprehensive CLI Command Analysis

### Overview

The CLI is built with the `@stricli/core` framework. The main entry point is `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/chkit.ts`. It defines a route map of commands and, for three commands (`plugin`, `codegen`, `pull`), bypasses the Stricli router entirely and dispatches directly to their handler functions with raw `argv` slices (lines 349-382). All other commands go through the Stricli `run()` router.

The CLI version is hardcoded as `'0.1.0'` at `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/version.ts:1`.

The Stricli scanner is configured with `caseStyle: 'allow-kebab-for-camel'` (line 346), so `--migration-id` maps to `migrationId`, `--allow-destructive` maps to `allowDestructive`, etc.

### Global JSON Output Contract

All JSON output is wrapped by `emitJson()` at `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/json-output.ts:36-38`, which calls `jsonPayload()` (lines 25-34). Every JSON envelope includes:

```json
{
  "command": "<command-name>",
  "schemaVersion": 1,
  ...commandSpecificFields
}
```

The constant `JSON_CONTRACT_VERSION` is `1` (line 13).

### Global Config Loading

Defined in `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/config.ts`.

- `DEFAULT_CONFIG_FILE` = `'clickhouse.config.ts'` (line 16)
- `getCommandContext()` (lines 77-87) reads `--config` and `--json` from args, calls `loadConfig()`, and returns `{ config, configPath, dirs, jsonMode }`
- `loadConfig()` (lines 39-62) resolves the config path relative to `process.cwd()`, dynamically imports it via `pathToFileURL`, reads `mod.default ?? mod.config`, calls `resolveConfig()` from `@chkit/core`
- Config not found error: `"Config not found at ${configPath}. Run 'chkit init' first."` (line 45)
- Invalid config error: `"Config file ${configPath} must export a default/config object or a function via defineConfig."` (line 52)

### Exit Code Handling

The `exitIfNeeded()` function at `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/chkit.ts:76-86` checks `process.exitCode` and calls `process.exit()` only if the code is a finite number greater than 0. This is called after every command dispatch for the Stricli-routed commands. For the direct-dispatch commands (`plugin`, `codegen`, `pull`), uncaught errors are caught and exit with code 1 (lines 350-376).

### Table Scope System

Defined in `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/table-scope.ts`.

The `--table` flag accepts selectors in these formats (validated by `parseTableSelector()` at lines 41-98):
- `<table>` -- exact match, any database
- `<table_prefix*>` -- prefix wildcard match, any database
- `<database.table>` -- exact match, specific database
- `<database.table_prefix*>` -- prefix wildcard match, specific database

Validation rules:
- Empty string is invalid (line 43-45)
- Database qualifier cannot be empty or contain `*` (lines 53-57)
- Bare `*` is not supported (lines 59-63)
- Only one `*` allowed, must be trailing (lines 65-76)

The `TableScope` interface (lines 14-19):
```typescript
interface TableScope {
  enabled: boolean      // false when no --table provided
  selector?: string     // the raw selector string
  matchedTables: string[]  // "database.table" keys
  matchCount: number
}
```

---

## Command: `chkit init`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/init.ts`

### Flags
None. Takes no arguments.

### Behavior
1. Resolves `configPath` to `<cwd>/clickhouse.config.ts` (line 6)
2. Resolves `schemaPath` to `<cwd>/src/db/schema/example.ts` (line 7)
3. Calls `writeIfMissing()` for each file -- only writes if the file does not already exist (config.ts lines 64-68 checks `existsSync()` first)
4. Prints the two created file paths to stdout (lines 19-21)

### Generated Config Template (lines 9-11)
The config template includes:
- `schema: './src/db/schema/**/*.ts'`
- `outDir: './chkit'`
- `migrationsDir: './chkit/migrations'`
- `metaDir: './chkit/meta'`
- `plugins: []` (with commented examples for typed and legacy plugin registration)
- `clickhouse` block reading from env vars `CLICKHOUSE_URL`, `CLICKHOUSE_USER`, `CLICKHOUSE_PASSWORD`, `CLICKHOUSE_DB` with defaults

### Generated Schema Template (lines 14-16)
Creates a sample `events` table definition with `MergeTree` engine, columns `id` (UInt64), `source` (String), `ingested_at` (DateTime64(3)), partitioned by `toYYYYMM(ingested_at)`.

### Exit Codes
- 0: Success (implicit)
- No explicit error exit codes; errors from file I/O would propagate as uncaught exceptions

### JSON Output
None. This command has no `--json` flag.

---

## Command: `chkit generate`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/generate.ts`

### Flags
| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--config <path>` | string | `clickhouse.config.ts` | Path to config file |
| `--name <name>` | string | undefined | Migration name |
| `--migration-id <id>` | string | undefined | Deterministic migration file prefix override |
| `--rename-table <mapping>` | string (CSV) | undefined | Explicit table rename `old_db.old_table=new_db.new_table` |
| `--rename-column <mapping>` | string (CSV) | undefined | Explicit column rename `db.table.old_column=new_column` |
| `--table <selector>` | string | undefined | Table scope selector |
| `--dryrun` | boolean | false | Print plan without writing artifacts |
| `--json` | boolean | false | Machine-readable JSON output |

### Core Flow (lines 41-189)
1. Parse flags: `--name`, `--migration-id`, `--table`, `--dryrun` (lines 42-45)
2. Load config via `getCommandContext()` (line 47)
3. Load plugin runtime and fire `onConfigLoaded` hook (lines 48-59)
4. Load schema definitions and fire `onSchemaLoaded` hook (lines 61-67)
5. Parse rename mappings from both CLI flags and schema metadata (`renamedFrom`) (lines 69-73)
6. Read previous snapshot from `metaDir/snapshot.json` (line 76)
7. Resolve table scope against union of previous + current definitions (lines 77-80)
8. If scope enabled and matchCount is 0, emit warning and return early (lines 82-97)
9. Validate rename mappings: no conflicts, CLI mappings resolvable (lines 99-101)
10. Resolve active table mappings, remap old definitions (lines 103-107)
11. Call `planDiff()` from `@chkit/core` (line 111)
12. Apply explicit table renames to plan (line 129)
13. Validate CLI column mappings, apply column rename suggestions (lines 130-131)
14. Fire `onPlanCreated` plugin hook (lines 133-140)
15. Filter plan by table scope if enabled (lines 142-146)
16. If `--dryrun`, emit plan output and return (lines 148-151)
17. Otherwise, call `generateArtifacts()` from `@chkit/codegen` (lines 162-170)
18. If codegen plugin is configured with `runOnGenerate !== false`, automatically run codegen (lines 172-186)
19. Emit apply output (line 188)

### Rename Mapping System

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/generate/rename-mappings.ts`

Two interfaces:
```typescript
interface TableRenameMapping {
  oldDatabase: string; oldName: string
  newDatabase: string; newName: string
  source: 'cli' | 'schema'
}

interface ColumnRenameMapping {
  database: string; table: string
  from: string; to: string
  source: 'cli' | 'schema'
}
```

Parsing:
- `parseRenameTableMappings()` (lines 19-37): Splits on `=`, expects `old_db.old_table=new_db.new_table`. Supports comma-separated values via `parseFlagValues()` (lines 251-260) which splits on `,`.
- `parseRenameColumnMappings()` (lines 39-62): Splits on `=`, expects `db.table.old_column=new_column`. Source parts split by `.` must have exactly 3 non-empty segments.

Merging: CLI mappings override schema mappings when they share the same old or new key (lines 96-138).

Validation errors:
- `"Conflicting table rename source mapping for ..."` (line 161)
- `"Conflicting table rename target mapping for ..."` (line 167)
- `"Unsupported chained or cyclic table rename mapping involving ..."` (line 175)
- `"Conflicting column rename source mapping for ..."` (line 190)
- `"Conflicting column rename target mapping for ..."` (line 197)
- Various `"--rename-table mapping ... is invalid: ..."` messages (lines 212-224)
- Various `"--rename-column mapping ... is invalid: ..."` messages (plan-pipeline.ts lines 147-163)

### Plan Pipeline

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/generate/plan-pipeline.ts`

Operation ranking order (`rankOperation()` at lines 167-173):
- `drop_*` operations: rank 0
- `create_database`: rank 1
- `alter_table_rename_table`: rank 2
- `alter_*` operations: rank 3
- All others: rank 4

Risk levels are `'safe' | 'caution' | 'danger'` (from `@chkit/core` RiskLevel type), summarized at lines 175-181.

### JSON Output Shapes

**Dryrun/Plan mode** (`GeneratePlanPayload` at output.ts:6-13):
```json
{
  "command": "generate",
  "schemaVersion": 1,
  "scope": { "enabled": bool, "selector": "...", "matchedTables": [...], "matchCount": N },
  "mode": "plan",
  "operationCount": N,
  "riskSummary": { "safe": N, "caution": N, "danger": N },
  "operations": [{ "type": "...", "key": "...", "risk": "...", "sql": "..." }],
  "renameSuggestions": [{ "kind": "column", "database": "...", "table": "...", "from": "...", "to": "...", "confidence": "high", "reason": "...", "confirmationSQL": "...", "dropOperationKey": "...", "addOperationKey": "..." }]
}
```

**Apply mode** (`GenerateApplyPayload` at output.ts:15-22):
```json
{
  "command": "generate",
  "schemaVersion": 1,
  "scope": { ... },
  "migrationFile": "path or null",
  "snapshotFile": "path",
  "definitionCount": N,
  "operationCount": N,
  "riskSummary": { "safe": N, "caution": N, "danger": N }
}
```

**Validation error** (generate.ts lines 114-120):
```json
{
  "command": "generate",
  "schemaVersion": 1,
  "error": "validation_failed",
  "issues": [{ "code": "...", "message": "..." }]
}
```

**Empty scope** (generate.ts lines 84-91):
```json
{
  "command": "generate",
  "schemaVersion": 1,
  "scope": { ... },
  "mode": "plan|apply",
  "operationCount": 0,
  "riskSummary": { "safe": 0, "caution": 0, "danger": 0 },
  "operations": [],
  "renameSuggestions": [],
  "warning": "No tables matched selector \"..\"."
}
```

### Exit Codes
- 0: Success (implicit)
- 1: Validation error from `ChxValidationError` (line 119 sets `process.exitCode = 1`)
- Thrown errors propagate for rename mapping validation failures and codegen plugin failures

---

## Command: `chkit migrate`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/migrate.ts`

### Flags
| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--config <path>` | string | `clickhouse.config.ts` | Path to config file |
| `--apply` | boolean | false | Apply pending migrations (no prompt) |
| `--execute` | boolean | false | Alias for `--apply` |
| `--allow-destructive` | boolean | false | Required for destructive operations in non-interactive mode |
| `--table <selector>` | string | undefined | Table scope selector |
| `--json` | boolean | false | Machine-readable JSON output |

### CI/Non-Interactive Detection (lines 30-31)
`isBackgroundOrCI()` returns `true` when any of:
- `process.env.CI === '1'`
- `process.env.CI === 'true'`
- `!process.stdin.isTTY`
- `!process.stdout.isTTY`

### Core Flow (lines 87-313)
1. Parse `--apply`/`--execute`, `--allow-destructive`, `--table` (lines 88-90)
2. Load config, read snapshot, resolve table scope (lines 92-95)
3. Load plugin runtime, fire `onConfigLoaded` (lines 97-107)
4. Ensure migrations directory exists (line 109)
5. List migration files (`.sql` files sorted alphabetically), read journal, find pending (lines 110-113)
6. Check for checksum mismatches on already-applied migrations (line 114)
7. **Checksum mismatch check** (lines 116-132): If any mismatch, abort immediately. JSON mode emits error payload with exit code 1. Text mode throws an error.
8. **Empty scope check** (lines 134-147): If table scope matches nothing, emit warning.
9. **Filter pending by scope** (lines 149-151): If scope enabled, filter pending migrations to those containing operations targeting matched tables. `filterPendingByScope()` (lines 60-85) reads each migration SQL, parses `-- operation:` comment lines, matches by table key or database key.
10. **No pending** (lines 153-165): If nothing pending, report and return.
11. **Plan-only mode** (lines 173-194): In JSON mode without `--apply`, emits plan payload and returns. In non-interactive mode without `--apply`, prints plan message. In interactive mode, prompts user with `"Apply pending migrations now? [no/yes]: "` (line 200).
12. **Destructive operation detection** (lines 212-253): Scans each pending file for `risk=danger` markers. If found and not allowed, behavior depends on context:
    - JSON mode: emits error payload with **exit code 3** (line 234)
    - Non-interactive/CI: throws error with details
    - Interactive: prompts user with `"Apply destructive operations? [no/yes]: "` (line 53), requires `"yes"`
13. **Execution** (lines 259-300): Creates ClickHouse executor, iterates pending files, extracts executable statements (strips comment lines, splits on `;`), fires `onBeforeApply` hook (can transform statements), executes each statement, records journal entry with ISO timestamp and SHA-256 checksum, fires `onAfterApply` hook.
14. **Journal persistence** (line 289): Journal is written after each migration, not batched.

### Destructive Operation Markers

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/safety-markers.ts`

`DestructiveOperationMarker` interface (lines 1-11):
```typescript
interface DestructiveOperationMarker {
  migration: string; type: string; key: string; risk: string
  warningCode: string; reason: string; impact: string; recommendation: string; summary: string
}
```

Warning codes by operation type (lines 66-103):
- `drop_table` -> `'drop_table_data_loss'`
- `alter_table_drop_column` -> `'drop_column_irreversible'`
- `drop_view` / `drop_materialized_view` -> `'drop_view_dependency_break'`
- All others -> `'destructive_operation_review_required'`

Detection: Scans for lines matching `-- operation:` that contain `risk=danger` (lines 37-43).

Statement extraction (`extractExecutableStatements()` at lines 20-31): Filters out lines starting with `--`, splits remaining on `;`, trims, filters empty, re-appends `;`.

### Checksum Algorithm
SHA-256 hash of the migration SQL file content (migration-store.ts lines 99-101).

### JSON Output Shapes

**Checksum mismatch error:**
```json
{
  "command": "migrate",
  "schemaVersion": 1,
  "mode": "execute|plan",
  "scope": { ... },
  "error": "Checksum mismatch detected on applied migrations",
  "checksumMismatches": [{ "name": "...", "expected": "sha256", "actual": "sha256" }]
}
```

**Empty scope:**
```json
{
  "command": "migrate",
  "schemaVersion": 1,
  "mode": "execute|plan",
  "scope": { ... },
  "pending": [],
  "applied": [],
  "warning": "No tables matched selector \"..\"."
}
```

**No pending / Plan mode:**
```json
{
  "command": "migrate",
  "schemaVersion": 1,
  "mode": "execute|plan",
  "scope": { ... },
  "pending": ["file1.sql", "file2.sql"]
}
```

**Destructive block:**
```json
{
  "command": "migrate",
  "schemaVersion": 1,
  "mode": "execute",
  "scope": { ... },
  "error": "Blocked destructive migration execution. Re-run with --allow-destructive or set safety.allowDestructive=true after review.",
  "destructiveMigrations": ["file.sql"],
  "destructiveOperations": [{ "migration": "...", "type": "...", "key": "...", "risk": "...", "warningCode": "...", "reason": "...", "impact": "...", "recommendation": "...", "summary": "..." }]
}
```

**Successful execution:**
```json
{
  "command": "migrate",
  "schemaVersion": 1,
  "mode": "execute",
  "scope": { ... },
  "applied": [{ "name": "...", "appliedAt": "ISO8601", "checksum": "sha256" }],
  "journalFile": "/path/to/journal.json"
}
```

### Exit Codes
- 0: Success
- 1: Checksum mismatch (line 124)
- 3: Destructive operations blocked in JSON mode (line 234)
- 1: Uncaught thrown errors (via top-level catch in chkit.ts)

### Config-Based Destructive Allow
`config.safety?.allowDestructive === true` also allows destructive operations (line 222).

---

## Command: `chkit status`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/status.ts`

### Flags
| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--config <path>` | string | `clickhouse.config.ts` | Path to config file |
| `--json` | boolean | false | Machine-readable JSON output |

### Core Flow (lines 7-46)
1. Load config context (line 8)
2. Ensure migrations directory exists (line 11)
3. List migration files, read journal, compute pending, find checksum mismatches (lines 12-16)
4. Build payload and emit (lines 18-45)

### JSON Output Shape
```json
{
  "command": "status",
  "schemaVersion": 1,
  "migrationsDir": "/absolute/path",
  "total": N,
  "applied": N,
  "pending": N,
  "pendingMigrations": ["file1.sql", ...],
  "checksumMismatchCount": N,
  "checksumMismatches": [{ "name": "...", "expected": "sha256", "actual": "sha256" }]
}
```

### Exit Codes
- 0: Always (no explicit failure conditions)

---

## Command: `chkit drift`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/drift.ts`

### Flags
| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--config <path>` | string | `clickhouse.config.ts` | Path to config file |
| `--table <selector>` | string | undefined | Table scope selector |
| `--json` | boolean | false | Machine-readable JSON output |

### Core Flow (lines 98-191)
1. Parse `--table`, load config context (lines 99-101)
2. Read snapshot; throws `"Snapshot not found. Run 'chkit generate' before drift checks."` if missing (lines 102-105)
3. Resolve table scope (line 106)
4. If scope matches nothing, emit empty drift payload (lines 107-129)
5. Call `buildDriftPayload()` which connects to ClickHouse (lines 30-96)
6. Emit payload (lines 132-190)

### `buildDriftPayload()` (lines 30-96)
1. Requires `config.clickhouse`; throws `"clickhouse config is required for drift checks"` (line 38)
2. Lists schema objects from ClickHouse via `db.listSchemaObjects()` (line 40)
3. Compares expected vs actual objects using `compareSchemaObjects()` from `drift.ts`
4. Fetches table details via `db.listTableDetails()` for all expected databases (line 68)
5. Compares table shapes using `compareTableShape()` from `drift.ts`
6. `drifted` is `true` if any: missing, extra, kindMismatches, objectDrift, or tableDrift (lines 78-83)

### DriftPayload Interface (lines 17-28)
```typescript
interface DriftPayload {
  scope?: TableScope
  snapshotFile: string
  expectedCount: number
  actualCount: number
  drifted: boolean
  missing: string[]
  extra: string[]
  kindMismatches: Array<{ expected: string; actual: string; object: string }>
  objectDrift: ObjectDriftDetail[]
  tableDrift: TableDriftDetail[]
}
```

### Drift Reason Codes

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/drift.ts`

**Object-level drift reason codes** (line 24):
- `'missing_object'`
- `'extra_object'`
- `'kind_mismatch'`

**Table-level drift reason codes** (lines 10-22):
- `'missing_column'`
- `'extra_column'`
- `'changed_column'`
- `'setting_mismatch'`
- `'index_mismatch'`
- `'ttl_mismatch'`
- `'engine_mismatch'`
- `'primary_key_mismatch'`
- `'order_by_mismatch'`
- `'partition_by_mismatch'`
- `'unique_key_mismatch'`
- `'projection_mismatch'`

**Engine normalization** (drift.ts lines 222-229): `normalizeEngine()` strips trailing `()`, lowercases, and normalizes `'sharedmergetree'` to `'mergetree'`.

### JSON Output Shape
```json
{
  "command": "drift",
  "schemaVersion": 1,
  "scope": { ... },
  "snapshotFile": "/path/to/snapshot.json",
  "expectedCount": N,
  "actualCount": N,
  "drifted": true|false,
  "missing": ["kind:database.name", ...],
  "extra": ["kind:database.name", ...],
  "kindMismatches": [{ "expected": "table", "actual": "view", "object": "db.name" }],
  "objectDrift": [{ "code": "missing_object|extra_object|kind_mismatch", "object": "...", "expectedKind": "...", "actualKind": "..." }],
  "tableDrift": [{ "table": "db.name", "reasonCodes": [...], "missingColumns": [...], "extraColumns": [...], "changedColumns": [...], "settingDiffs": [...], "indexDiffs": [...], "ttlMismatch": bool, "engineMismatch": bool, "primaryKeyMismatch": bool, "orderByMismatch": bool, "uniqueKeyMismatch": bool, "partitionByMismatch": bool, "projectionDiffs": [...] }]
}
```

### Exit Codes
- 0: Always (drift detection does not set non-zero exit codes)
- Thrown errors for missing snapshot or missing clickhouse config

---

## Command: `chkit check`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/check.ts`

### Flags
| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--config <path>` | string | `clickhouse.config.ts` | Path to config file |
| `--strict` | boolean | false | Force all check policies on |
| `--json` | boolean | false | Machine-readable JSON output |

### Policy Defaults (lines 25-29)
```typescript
policy = {
  failOnPending:           strict ? true : config.check?.failOnPending ?? true,
  failOnChecksumMismatch:  strict ? true : config.check?.failOnChecksumMismatch ?? true,
  failOnDrift:             strict ? true : config.check?.failOnDrift ?? true,
}
```
All three default to `true`. The `--strict` flag overrides all to `true` regardless of config.

### Core Flow (lines 11-134)
1. Parse `--strict`, load config context (lines 12-14)
2. List migrations, read journal, find pending and checksum mismatches (lines 17-21)
3. Read snapshot; if snapshot and `config.clickhouse` both exist, run `buildDriftPayload()` (line 23)
4. Load plugin runtime, fire `onConfigLoaded`, run `onCheck` hooks (lines 31-46)
5. Evaluate failed checks (lines 48-57):
   - `'pending_migrations'` if policy on and pending > 0
   - `'checksum_mismatch'` if policy on and mismatches > 0
   - `'schema_drift'` if policy on and drift detected
   - `'plugin:<name>'` for each plugin check with `evaluated && !ok` and at least one `severity === 'error'` finding
6. Summarize drift reasons (lines 59-64)
7. Build and emit payload (lines 66-133)

### JSON Output Shape
```json
{
  "command": "check",
  "schemaVersion": 1,
  "strict": true|false,
  "policy": {
    "failOnPending": bool,
    "failOnChecksumMismatch": bool,
    "failOnDrift": bool
  },
  "ok": true|false,
  "failedChecks": ["pending_migrations", "checksum_mismatch", "schema_drift", "plugin:name"],
  "pendingCount": N,
  "checksumMismatchCount": N,
  "drifted": true|false,
  "driftEvaluated": true|false,
  "driftReasonCounts": { "missing_column": N, ... },
  "driftReasonTotals": { "total": N, "object": N, "table": N },
  "plugins": {
    "<pluginName>": {
      "evaluated": bool,
      "ok": bool,
      "findingCodes": ["code1", "code2"],
      ...metadata
    }
  }
}
```

### Exit Codes
- 0: All checks pass (`ok === true`)
- 1: Any check fails (`!ok`), set at line 96 and line 132

---

## Command: `chkit pull`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/pull.ts`

### Flags
Inherits global flags: `--config`, `--json`, `--table`. Additional flags are passed through to the pull plugin.

From the help text in `chkit.ts` (line 22):
| Flag | Type | Description |
|------|------|-------------|
| `--out-file <path>` | string | Override output file path |
| `--database <db>` | string | Limit pull to one or more databases (repeat or comma-separate) |
| `--dryrun` | boolean | Print operation plan without writing artifacts |
| `--force` | boolean | Allow overwrite of existing output file |

### Behavior (lines 3-25)
This command is a plugin delegation wrapper.

1. Calls `buildPluginLikeContext()` with `command: 'pull'` and `handleInvalidPluginOptions: true` (lines 4-8)
2. Looks for a plugin with `manifest.name === 'pull'` (line 11)
3. Invokes the plugin's `'schema'` command (line 12)
4. If the pull plugin is not configured, throws `"Pull plugin is not configured. Add a plugin with manifest.name \"pull\" to config.plugins."` (line 19)
5. If the pull plugin does not have a `schema` command, throws a message listing available commands (lines 21-23)

### Plugin-Like Context Building

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/plugin-like.ts`

`buildPluginLikeContext()` (lines 64-103):
1. Strips global flags (`--json`, `--config`, `--table`) from args via `stripGlobalFlags()` (lines 45-62)
2. Loads config, schema definitions, resolves table scope, loads plugin runtime (lines 68-76)
3. Fires `onConfigLoaded` hook (lines 78-93)
4. If `handleInvalidPluginOptions` is `true` and `onConfigLoaded` throws an error containing `"Invalid plugin option"`, it prints the error and sets **exit code 2** (lines 86-91)

`runPluginLikeCommand()` (lines 105-150):
- If plugin not found and no custom message: `"Unknown plugin \"...\". Available: ..."`
- If command not found and no custom message: `"Unknown command \"...\" for plugin \"...\". Available: ..."`
- Calls `runtime.runPluginCommand()` which returns an exit code (0 for success); non-zero exit code is set on `process.exitCode` (line 149)

### Exit Codes
- 0: Plugin command succeeded
- 2: Invalid plugin options (line 89)
- Non-zero: Plugin command returns non-zero (line 149)
- 1: Uncaught error (via top-level catch in chkit.ts line 375)

---

## Command: `chkit codegen`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/codegen.ts`

### Flags
From the help text in `chkit.ts` (line 23):
| Flag | Type | Description |
|------|------|-------------|
| `--check` | boolean | Validate generated type artifacts are up-to-date |
| `--out-file <path>` | string | Override output file path |
| `--emit-zod` | boolean | Enable Zod validator generation |
| `--no-emit-zod` | boolean | Disable Zod validator generation |
| `--emit-ingest` | boolean | Enable ingestion function generation |
| `--no-emit-ingest` | boolean | Disable ingestion function generation |
| `--ingest-out-file <path>` | string | Override ingestion output file path |
| `--bigint-mode <mode>` | string | Set large integer mapping mode (`string` or `bigint`) |
| `--include-views` | boolean | Include views in codegen output |

### Behavior (lines 3-25)
Identical delegation pattern to `pull`:
1. Calls `buildPluginLikeContext()` with `command: 'codegen'` and `handleInvalidPluginOptions: true`
2. Looks for a plugin with `manifest.name === 'codegen'`
3. Invokes the plugin's `'codegen'` command
4. If not configured: `"Codegen plugin is not configured. Add a plugin with manifest.name \"codegen\" to config.plugins."`
5. If command not found: lists available commands

### Exit Codes
Same as `pull` (delegated to plugin).

---

## Command: `chkit plugin`

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/commands/plugin.ts`

### Flags
| Flag | Type | Description |
|------|------|-------------|
| `--config <path>` | string | Path to config file |
| `--json` | boolean | Machine-readable JSON output |

### Subcommand Syntax
```
chkit plugin                           # List all plugins
chkit plugin <plugin-name>             # List commands for a specific plugin
chkit plugin <plugin-name> <command>   # Run a plugin command
```

Parsed by `parsePluginInvocation()` at lines 4-14: `args[0]` is `pluginName`, `args[1]` is `commandName`, `args.slice(2)` is forwarded command args.

### Core Flow (lines 16-110)
1. Build plugin-like context (lines 17-21)
2. Parse plugin invocation from remaining args (line 22)
3. **No plugins configured** (lines 24-34): If `runtime.plugins.length === 0`, JSON mode emits error with exit code 1; text mode throws `"No plugins configured. Add entries to config.plugins first."`
4. **List all plugins** (lines 36-64): If no `pluginName`, lists all plugins with name, version, commands
5. **Unknown plugin** (lines 67-75): Throws `"Unknown plugin \"...\". Available: ..."`
6. **List plugin commands** (lines 77-101): If `pluginName` but no `commandName`, lists commands for that plugin
7. **Run command** (lines 104-109): Delegates to `runPluginLikeCommand()`

### JSON Output Shapes

**List all plugins:**
```json
{
  "command": "plugin",
  "schemaVersion": 1,
  "plugins": [{
    "name": "...",
    "version": "1.0.0" | null,
    "commands": [{ "name": "...", "description": "..." }]
  }]
}
```

**List plugin commands:**
```json
{
  "command": "plugin",
  "schemaVersion": 1,
  "plugin": "plugin-name",
  "commands": [{ "name": "...", "description": "..." }]
}
```

**No plugins error:**
```json
{
  "command": "plugin",
  "schemaVersion": 1,
  "error": "No plugins configured. Add entries to config.plugins first.",
  "plugins": []
}
```

### Exit Codes
- 0: Success
- 1: No plugins configured (line 31)
- Non-zero: Plugin command returns non-zero (via `runPluginLikeCommand`)

---

## Plugin Runtime System

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/plugin-runtime.ts`

### Plugin Registration Formats (lines 73-111)
Three registration forms are supported:
1. **String path**: `'./plugins/my-plugin.ts'` -> resolved relative to config file directory
2. **Legacy object**: `{ resolve: './path', name?: string, enabled?: boolean, options?: {} }`
3. **Inline object**: Detected by `isInlinePluginRegistration()` from `../plugins.js` -> `{ plugin: ChxPlugin, name?: string, enabled?: boolean, options?: {} }`

### Plugin Validation (lines 118-144)
- Manifest `name` must be non-empty (line 120)
- `apiVersion` must be `1` (line 124)
- CLI compatibility checked via `manifest.compatibility.cli.minMajor` and `maxMajor` (lines 130-143)
- Duplicate plugin names throw (line 191)
- Name mismatch between config hint and manifest throws (lines 184-188)

### Plugin Lifecycle Hooks
Executed in registration order for all loaded plugins:
1. `onConfigLoaded` -- receives command, config, configPath, tableScope, options
2. `onSchemaLoaded` -- can return modified definitions (canonicalized)
3. `onPlanCreated` -- can return modified plan
4. `onBeforeApply` -- can return modified statements array
5. `onAfterApply` -- notification only
6. `onCheck` -- returns check results with findings
7. `onCheckReport` -- receives results and a print function

### Command Execution (lines 313-329)
`runPluginCommand()` returns:
- `1` if plugin or command not found
- The numeric return value from `command.run()`, or `0` if non-numeric
- Errors are wrapped: `Plugin "<name>" failed in command:<commandName>: <message>`

---

## Migration Store

**File:** `/Users/marc/conductor/workspaces/chkit/davao/packages/cli/src/bin/migration-store.ts`

### Key Data Structures

```typescript
interface MigrationJournalEntry {
  name: string       // filename
  appliedAt: string  // ISO 8601 timestamp
  checksum: string   // SHA-256 hex
}

interface MigrationJournal {
  version: 1
  applied: MigrationJournalEntry[]
}

interface ChecksumMismatch {
  name: string
  expected: string  // stored checksum
  actual: string    // current file checksum
}
```

### Backward Compatibility
`readJournal()` (lines 55-86) normalizes old journal formats where `applied` could be an array of strings (plain filenames) rather than objects. String entries are converted to entries with empty `appliedAt` and `checksum`.

### File Locations
- Snapshot: `<metaDir>/snapshot.json`
- Journal: `<metaDir>/journal.json`
- Migrations: `<migrationsDir>/*.sql` (sorted alphabetically)

---

## Command: `chkit help`

Defined inline in `chkit.ts` lines 322-330. Calls `printHelp()` which outputs the full usage text (lines 17-65). No flags, no JSON output.

## Command: `chkit version`

Defined inline in `chkit.ts` lines 331-339. Outputs `CLI_VERSION` (`'0.1.0'`) to stdout. No flags, no JSON output.

---

## Summary of All Exit Codes

| Code | Source | Meaning |
|------|--------|---------|
| 0 | Default | Success |
| 1 | `generate` | Validation error (`ChxValidationError`) |
| 1 | `migrate` | Checksum mismatch on applied migrations |
| 1 | `check` | One or more policy checks failed |
| 1 | `plugin` | No plugins configured |
| 1 | Top-level catch | Any uncaught error |
| 1 | Plugin runtime | Plugin/command not found (returned by `runPluginCommand`) |
| 2 | `plugin-like.ts` | Invalid plugin options during `onConfigLoaded` |
| 3 | `migrate` | Destructive operations blocked (JSON mode) |</result>
<usage>total_tokens: 64856
tool_uses: 28
duration_ms: 224613</usage>
</task-notification>
Full transcript available at: /private/tmp/claude-501/-Users-marc-conductor-workspaces-chkit-davao/tasks/a59284b.output

---

if its finished, delete the plan document